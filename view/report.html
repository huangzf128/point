{% extends "layout.html" %}

{% block link %}
<link rel="stylesheet" href="css/menutree.css?{{tm}}">
{% endblock %}

{% block style %}
.card {
	background: floralwhite;
}
{% endblock %}

{% block content %}
<div class="container">

	<ul class="breadcrumb">
		<li><a href="">スタートメニュー</a> <span class="divider">&gt;</span></li>
		<li class=active>帳票出力</li>
	</ul>

	<div class="col">

		<div class="card">
			<div class="filter">
			</div>
			<div class="card-body row">
				
				<div class="col-10 col-md-3 mt-3">
					<select class="form-select-sm float-start me-2" id="report-sel" style="width:auto;">
						<option value=""> 帳票を選んでください</option>
						<option value="1" {{ report==1 ? "selected" : "" }}>見積書</option>
						<!-- <option value="2" {{ report==2 ? "selected" : "" }}>見積依頼書</option> -->
						<!-- <option value="3" {{ report==3 ? "selected" : "" }}>注文書</option> -->
						<option value="4" {{ report==4 ? "selected" : "" }}>請求書&送り状</option>
						<option value="5" {{ report==5 ? "selected" : "" }}>納品書&受領書</option>
                        <!-- <option value="6" {{ report==6 ? "selected" : "" }}>出荷証明書</option> -->
					</select>
				</div>
				<div class="col-10 col-md-9 mt-3">
					<button type="button" class="btn btn-success btn-sm float-start me-3 mb-2" id="btn-add-customer" data-bs-toggle="modal" 
							data-bs-target="#customer-modal">取引先選択</button>
					<span id="customerName">{{ customerName }}</span>
				</div>
			</div>
		</div>


		<div id="item-detail" class="card">
			<div class="filter">
				<button id="btn-print" type="button" class="btn btn-primary btn-sm me-3">出力</button>
			</div>

			<div class="card-body">
				<h5 class="card-title">出力商品一覧</h5>
				<button type="button" class="btn btn-success btn-sm float-start me-3 mb-2" id="btn-add-item" data-bs-toggle="modal" 
						data-bs-target="#item-modal">商品追加</button>

					<table id="tab-detail" class="table table-striped table-sm" data-mobile-responsive="true">
						<colgroup>
							<col class="col-md-2">
							<col class="col-md-3">
							<col class="col-md-2">
							<col class="col-md-1">
							<col class="col-md-1">
							<col class="col-md-1">
							<col class="col-md-1">
						</colgroup>
						<thead>
							<tr>
								<th scope="col" data-field="serial" data-sortable="true">商品番号</th>
								<th scope="col" data-field="itemName" data-sortable="true">商品名</th>
								<th scope="col" data-field="size" data-sortable="true">サイズ</th>
								<th scope="col" data-field="unit" data-sortable="true">単位</th>
								<th scope="col" data-field="price" data-events="inputEvents" data-formatter='inputFormatter'>価格</th>
								<th scope="col" data-field="quantity" data-events="inputEvents" data-formatter='quantityFormatter'>数量</th>
								<th data-formatter='Formatter.remove' data-align="center" data-events="operateEvents">操作</th>
								<th scope="col" data-field="itemId" data-visible="false"></th>
							</tr>
						</thead>
						<tbody>
							{% for item in invItems %}
							<tr>
								<td id="serial{{ loop.index }}">{{ item.serial}}</td>
								<td id="itemName{{ loop.index }}">{{ item.itemName}}</td>
								<td>{{ item.size}}</td>
								<td>{{ item.unit}}</td>
								<td>{{ item.price}}</td>
								<td>{{ item.quantity}}</td>
								<td>{{ item.itemId}}</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
			</div>
		</div>
		
	</div>
</div><!-- end container -->
<br />

<form id="frm" method="post" action="">
	<input type="hidden" name="ym" id="ym" value="{{ ym }}"/>
	<input type="hidden" name="addData" id="addData" />
	<input type="hidden" name="detailId" id="detailId"/>
	<input type="hidden" name="reportId" id="reportId"/>
	<input type="hidden" name="customerId" id="customerId" value="{{ customerId }}"/>
</form>


{% endblock %}


{% block script %}
<script>
	operateEvents = {
		'click .remove': function (e, value, row, index) {
			$('#tab-detail').bootstrapTable('remove', { field: 'itemId', values: [row.itemId] });
			hideRowItem.splice($.inArray(index, hideRowItem), 1);
			$('#tab-item').bootstrapTable('resetSearch');
		},
		'click .add': function (e, value, row, index) {
			$(e.target).parents('td').eq(0).addClass('hide-added');
			hideRowItem.push(row['itemId']);
			$('#tab-detail').bootstrapTable('append', { 'serial': row['serial'], 'itemName': row['itemName'], 'quantity': "", 'quantityDb': "",
														'itemId': row['itemId']});
		}
	}

	operateHistoryEvents = {
		'click .add': function (e, value, row, index) {
			if ($('#tab-detail').bootstrapTable('getData').length > 0 &&
				!confirm("入力された情報がなくなります。よろしいですか？")) {
				return;
			}			

			sendAjax("report/getOutHistory", {id: row['id']}, function(data) {

				$('#tab-detail').bootstrapTable('load', data);
				$.each(data, function(i, val) {
					hideRowItem.push(val['itemId'] + "");
				});
				$('#tab-item').bootstrapTable('resetSearch');
			});
		}
	}

	function getSelections() {
		return $.map($('#tab-detail').bootstrapTable('getData'), function (row) {
			return {"id": row.id, "serial": row.serial, "itemId": row.itemId, "itemName": row.itemName, "quantity": row.quantity, "price": row.price, "size": row.size, "unit": row.unit };
		})
	}

	$(function () {
		$('#tab-detail').bootstrapTable();

		binding();
	})

	function binding() {

		$('#btn-print').click(function() {

			const reportId = $('#report-sel').val();
			if (!reportId) {
				alert("帳票を選んでください。");
				return;
			}

			if (!$('#customerId').val()) {
				alert("取引先を選んでください。");
				return;
			}

			const tabData = getSelections();
			if (tabData.length == 0) {
				return;
			}

			$('#addData').val(JSON.stringify(tabData));
			$('#reportId').val(reportId);
			$("#frm").attr("action", "report/print").submit();
		});
	}

	function quantityFormatter(value, row, index) {
		if ($('#report-sel').val() == 1) {
			row.quantity = 1;
			return [
				'<input type="number" min="0" class="form-control form-control-sm" name="quantity" value="1"/>'
			].join('')
		} else {
			return [
				'<input type="number" min="0" class="form-control form-control-sm" name="quantity" value="' + value + '"/>'
			].join('')
		}
	}

	function customerCallback(data) {
		$('#customerName').text(data['name']);
		$('#customerId').val(data['id']);
	}

</script>
{% endblock %}

{% block component %}
	{% include 'includes/item_modal.php' %}
	{% include 'includes/customer_modal.php' %}
{% endblock %}